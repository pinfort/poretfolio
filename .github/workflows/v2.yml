name: Automatic deploy

on:
  push:
    branches:
      - feature-v2

jobs:
  prepare:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Run composer install
        run: composer install

      - name: setup .env
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Generate Laroute info
        run: php artisan laroute:generate

  php:
    needs: prepare
    steps:
      - name: Run PHPUnit
        run: ./vendor/bin/phpunit

  js:
    needs: prepare
    steps:
      - name: Run yarn install
        run: yarn install

      - name: Build Javascript
        run: yarn run dev

  deploy:
    needs: [php, js]
    steps:
      - name: Trigger beta deploy
        run: curl ${BETA_HOST}/api/dev_ops/auto_deploy?deploy_token=${DEPLOY_TOKEN}
        env:
          BETA_HOST: ${{ secrets.BETA_HOST }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
